name: Build and Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nsis genisoimage

    - name: Setup mkisofs symlink
      run: |
        # mac.gradle expects ./mkisofs in the root when running on non-Windows/non-Mac
        ln -s $(which mkisofs) ./mkisofs

    - name: Build and Export
      run: |
        chmod +x gradlew
        ./gradlew exportAll

    - name: List artifacts
      run: ls -R build/export/

    - name: Release
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/master'
      with:
        tag_name: build-${{ github.run_number }}
        name: "${{ github.event.head_commit.message || format('Build {0}', github.run_number) }}"
        files: |
          build/export/*.zip
          build/export/*.exe
          build/export/*.tar.gz
          build/export/*.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
