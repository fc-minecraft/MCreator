name: Build, Test and Release

permissions:
  contents: write
  checks: write
  statuses: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch: {}

jobs:
  setup:
    name: Prepare Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
      title: ${{ steps.release_info.outputs.title }}
      prerelease: ${{ steps.release_info.outputs.prerelease }}
      is_snapshot: ${{ steps.release_info.outputs.is_snapshot }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Release Info
        id: release_info
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"release"* ]]; then
            echo "tag_name=release-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "title=Production Release #${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
          else
            echo "tag_name=pre-release" >> $GITHUB_OUTPUT
            echo "title=Development Build (Latest)" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
          fi

      - name: Reset Pre-release Tag
        if: steps.release_info.outputs.prerelease == 'true'
        continue-on-error: true
        run: |
          git push --delete origin pre-release || true
          git tag -d pre-release || true

  build-linux-windows:
    name: Build Linux & Windows
    needs: [setup]
    if: always() && (needs.setup.result == 'success' || github.event_name == 'pull_request')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Cache MCreator Assets
        uses: actions/cache@v4
        with:
          path: ~/.mcreator
          key: mcreator-assets-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            mcreator-assets-${{ runner.os }}-

      - name: Cache NSIS Resource
        id: cache-nsis
        uses: actions/cache@v4
        with:
          path: LockedList.zip
          key: nsis-lockedlist-v1

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mkisofs nsis nsis-pluginapi
          if [ ! -f LockedList.zip ]; then
            wget -q https://nsis.sourceforge.io/mediawiki/images/d/d3/LockedList.zip
          fi
          sudo unzip -o -q LockedList.zip -d /usr/share/nsis/

      - name: Build and Export
        env:
          SNAPSHOT: ${{ needs.setup.outputs.is_snapshot }}
        run: |
          ARGS="generateExportReport exportLinux exportWindows --parallel --build-cache --configure-on-demand -Dorg.gradle.jvmargs=-Xmx3g -Dorg.gradle.vfs.watch=false -Dorg.gradle.console=plain -Dorg.gradle.java.home=$JAVA_HOME"
          
          if [[ "$SNAPSHOT" == "true" ]]; then
            ARGS="$ARGS -Psnapshot=true"
          fi
          
          xvfb-run -a ./gradlew $ARGS

      - name: Upload Assets
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag_name }}
          name: ${{ needs.setup.outputs.title }}
          body: |
            Build commit: ${{ github.sha }}
            Targets: Linux, Windows
          prerelease: ${{ needs.setup.outputs.prerelease }}
          files: |
            build/export/*
            build/distributions/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS
    needs: [setup]
    if: always() && (needs.setup.result == 'success' || github.event_name == 'pull_request')
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Cache MCreator Assets
        uses: actions/cache@v4
        with:
          path: ~/.mcreator
          key: mcreator-assets-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            mcreator-assets-${{ runner.os }}-

      - name: Install Build Dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: brew install create-dmg

      - name: Build and Export
        env:
          SNAPSHOT: ${{ needs.setup.outputs.is_snapshot }}
        run: |
          ARGS="generateExportReport exportMac --parallel --build-cache --configure-on-demand -Dorg.gradle.jvmargs=-Xmx3g -Dorg.gradle.vfs.watch=false -Dorg.gradle.console=plain -Dorg.gradle.java.home=$JAVA_HOME"
          
          if [[ "$SNAPSHOT" == "true" ]]; then
            ARGS="$ARGS -Psnapshot=true"
          fi
          
          ./gradlew $ARGS

      - name: Upload Assets
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag_name }}
          name: ${{ needs.setup.outputs.title }}
          body: |
            Build commit: ${{ github.sha }}
            Target: macOS
          prerelease: ${{ needs.setup.outputs.prerelease }}
          files: |
            build/export/*
            build/distributions/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}